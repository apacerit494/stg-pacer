name: CI/CD Deployment

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Staging via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_VPS_HOST }}
          username: ${{ secrets.STAGING_VPS_USER }}
          key: ${{ secrets.STAGING_VPS_KEY }}
          port: 22
          script: |
            echo "=== DEPLOYING TO STAGING SERVER ==="
            cd /home/stg.pacer.co.id/public_html

            echo "Resetting local changes..."
            git reset --hard HEAD

            echo "Pulling latest code from master..."
            git pull origin master

            echo "Installing dependencies via Composer..."
            composer install --no-dev --optimize-autoloader

            echo "Clearing writable cache..."
            rm -rf writable/cache/* || true

            echo "Setting folder permissions..."
            chmod -R 775 writable

            echo "Staging deployment completed successfully!"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PRODUCTION_VPS_HOST }}
          username: ${{ secrets.PRODUCTION_VPS_USER }}
          key: ${{ secrets.PRODUCTION_VPS_KEY }}
          port: 22
          script: |
            echo "=== DEPLOYING TO PRODUCTION SERVER ==="
            cd /home/pacer.co.id/public_html

            echo "Backing up database before deployment..."
            bash /home/pacer.co.id/backup.sh || true

            echo "Resetting local changes..."
            git reset --hard HEAD

            echo "Fetching latest tags..."
            git fetch --tags

            echo "Checking out release tag: $GITHUB_REF_NAME"
            git checkout $GITHUB_REF_NAME

            echo "Installing dependencies via Composer..."
            composer install --no-dev --optimize-autoloader

            
            echo "Clearing writable cache..."
            rm -rf writable/cache/* || true

            echo "Setting folder permissions..."
            chmod -R 775 writable

            echo "Production deployment completed successfully!"
